<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExamPrep Pro | Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Custom Styles inspired by tsion.html for a modern, sleek look */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --card-bg: rgba(30, 41, 59, 0.7);
            --border-color: rgba(255, 255, 255, 0.1);
            --primary-accent: #3b82f6;
            --secondary-accent: #10b981;
            --tertiary-accent: #8b5cf6;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
        }

        .light-mode {
            --bg-primary: #f1f5f9;
            --bg-secondary: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.8);
            --border-color: rgba(0, 0, 0, 0.1);
            --primary-accent: #2563eb;
            --secondary-accent: #059669;
            --tertiary-accent: #7c3aed;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            background-image: radial-gradient(circle at 1px 1px, rgba(128, 128, 128, 0.05) 1px, transparent 0);
            background-size: 20px 20px;
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-accent), #60a5fa);
            transition: all 0.3s ease;
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: background-color 0.3s ease;
        }
        
        .btn-secondary:hover {
            background-color: var(--bg-secondary);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }

        .form-input {
            background-color: rgba(128, 128, 128, 0.1);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .form-input:focus {
            border-color: var(--primary-accent);
            background-color: rgba(128, 128, 128, 0.15);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        
        .premium-feature::after {
            content: 'PREMIUM';
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 99px;
            letter-spacing: 0.5px;
        }
        
        .disabled-feature {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #desmosFrame {
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .option {
            transition: all 0.2s ease;
            border: 2px solid var(--border-color);
        }
        .option.selected {
            border-color: var(--primary-accent);
            background-color: rgba(59, 130, 246, 0.2);
        }

        .grid-item {
            border: 2px solid var(--border-color);
        }
        .grid-item.current { background-color: var(--primary-accent); border-color: var(--primary-accent); color: white; }
        .grid-item.answered { background-color: var(--secondary-accent); border-color: var(--secondary-accent); color: white; }
        .grid-item.marked { background-color: #f59e0b; border-color: #f59e0b; color: white; }

        .loader {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Prose styles for modal content */
        .prose { color: var(--text-secondary); }
        .prose h1, .prose h2, .prose h3, .prose h4 { color: var(--text-primary); }
        .prose strong { color: var(--text-primary); }
        .prose a { color: var(--primary-accent); }
        .prose code { background-color: var(--bg-secondary); padding: 2px 4px; border-radius: 4px; }

    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="loading-view" class="flex flex-col items-center gap-4">
        <div class="loader"></div>
        <p class="text-lg text-text-secondary">Initializing ExamPrep Pro...</p>
    </div>
    
    <div id="auth-view" class="hidden w-full max-w-md">
        <div class="glass-card rounded-2xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 text-transparent bg-clip-text">ExamPrep Pro</h1>
                <p class="text-text-muted mt-2">Your AI-Powered Study Partner</p>
            </div>

            <div id="auth-forms">
                <form id="login-form" class="space-y-4">
                    <input type="text" id="login-identifier" placeholder="Username or Email" class="w-full p-3 rounded-lg form-input" required>
                    <input type="password" id="login-password" placeholder="Password" class="w-full p-3 rounded-lg form-input" required>
                    <button type="submit" class="w-full py-3 rounded-lg font-semibold btn-primary">Log In</button>
                    <p class="text-sm text-center text-text-muted">Don't have an account? <a href="#" id="show-signup" class="font-semibold text-primary-accent hover:underline">Sign Up</a></p>
                </form>

                <form id="signup-form" class="hidden space-y-4">
                    <input type="text" id="signup-name" placeholder="Full Name" class="w-full p-3 rounded-lg form-input" required>
                    <input type="text" id="signup-username" placeholder="Username" class="w-full p-3 rounded-lg form-input" required>
                    <input type="email" id="signup-email" placeholder="Email" class="w-full p-3 rounded-lg form-input" required>
                    <input type="password" id="signup-password" placeholder="Password" class="w-full p-3 rounded-lg form-input" required>
                    <button type="submit" class="w-full py-3 rounded-lg font-semibold btn-primary">Create Account</button>
                    <p class="text-sm text-center text-text-muted">Already have an account? <a href="#" id="show-login" class="font-semibold text-primary-accent hover:underline">Log In</a></p>
                </form>
                 <p id="auth-error" class="text-red-400 text-sm text-center mt-4"></p>
            </div>

            <div class="mt-6 pt-6 border-t border-border-color">
                <p class="text-center text-sm text-text-muted mb-3">First time setting up? Click below to load questions.</p>
                <button id="setup-db-btn" class="w-full py-3 rounded-lg font-semibold btn-warning">
                    <i class="fas fa-database mr-2"></i>Initialize Database (One-Time Step)
                </button>
                <p id="setup-status" class="text-center text-sm mt-2"></p>
            </div>

            <div class="text-center text-xs text-text-muted mt-6">
                <a href="#" class="hover:underline" onclick="showPrivacyPolicy()">Privacy Policy</a> &bull; <a href="#" class="hover:underline" onclick="showPrivacyPolicy()">Terms of Service</a>
            </div>
        </div>
    </div>

    <div id="dashboard-view" class="hidden w-full max-w-6xl">
        <div class="glass-card rounded-2xl p-8">
            <header class="flex flex-wrap justify-between items-center pb-6 border-b border-border-color gap-4">
                <div>
                    <h2 class="text-3xl font-bold">Welcome, <span id="user-name"></span>!</h2>
                    <p class="text-text-muted">Let's get you ready for your exam.</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-yellow-400 flex items-center gap-2"><i class="fas fa-fire"></i> <span id="streak-count">0</span></div>
                        <div class="text-xs text-text-muted">Day Streak</div>
                    </div>
                    <div id="user-tier-badge" class="px-4 py-1 rounded-full font-semibold text-sm"></div>
                    <button id="theme-toggle-btn" title="Toggle Theme" class="btn-secondary rounded-full w-12 h-12 flex items-center justify-center text-lg"><i class="fas fa-sun"></i></button>
                    <button id="logout-button" class="btn-secondary px-4 py-2 rounded-lg font-semibold"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
                </div>
            </header>

            <main class="mt-8">
                <h3 class="text-2xl font-semibold mb-6">Choose Your Practice Test</h3>
                <div class="grid md:grid-cols-3 gap-6" id="test-selection-grid">
                    </div>

                <h3 class="text-2xl font-semibold mt-12 mb-6">Premium Features</h3>
                <div class="grid md:grid-cols-3 gap-6">
                    <div id="ai-tutor-card" class="relative glass-card p-6 rounded-xl flex flex-col items-center text-center hover:border-primary-accent transition-all duration-300 cursor-pointer">
                        <i class="fas fa-robot text-4xl text-primary-accent mb-4"></i>
                        <h4 class="text-xl font-semibold mb-2">AI Tutor</h4>
                        <p class="text-text-muted text-sm">Get instant help and explanations for any question from Gemini.</p>
                    </div>
                     <div class="relative glass-card p-6 rounded-xl flex flex-col items-center text-center disabled-feature premium-feature">
                        <i class="fas fa-chart-line text-4xl text-text-muted mb-4"></i>
                        <h4 class="text-xl font-semibold mb-2">Performance Analytics</h4>
                        <p class="text-text-muted text-sm">In-depth analysis of your strengths and weaknesses.</p>
                    </div>
                    <div class="relative glass-card p-6 rounded-xl flex flex-col items-center text-center disabled-feature premium-feature">
                        <i class="fas fa-tasks text-4xl text-text-muted mb-4"></i>
                        <h4 class="text-xl font-semibold mb-2">Personalized Study Plan</h4>
                        <p class="text-text-muted text-sm">An AI-generated plan tailored to your progress.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="test-view" class="hidden w-full max-w-7xl">
         <div class="glass-card rounded-2xl p-6">
             <header class="flex flex-wrap justify-between items-center gap-4 pb-4 border-b border-border-color">
                 <div>
                     <h2 class="text-2xl font-bold" id="test-view-title"></h2>
                     <p class="text-text-muted text-sm" id="test-view-subtitle"></p>
                 </div>
                 <div class="flex items-center gap-4">
                     <span class="text-text-secondary hidden md:block">Signed in as <strong id="test-view-user-name"></strong></span>
                     <div id="test-timer-display" class="text-2xl font-mono font-bold bg-red-500/20 text-red-300 px-4 py-2 rounded-lg"></div>
                     <button id="finish-test-btn" class="btn-secondary px-4 py-2 rounded-lg font-semibold"><i class="fas fa-flag-checkered mr-2"></i>Finish</button>
                     <button id="back-to-dashboard-btn" class="btn-secondary px-4 py-2 rounded-lg font-semibold"><i class="fas fa-arrow-left mr-2"></i>Dashboard</button>
                 </div>
             </header>

             <div class="grid lg:grid-cols-3 gap-6 mt-6">
                 <div class="lg:col-span-2 bg-black/20 p-6 rounded-xl">
                     <div class="flex justify-between items-center mb-4">
                         <p class="font-semibold" id="question-number-display"></p>
                         <button id="mark-review-btn" class="btn-secondary px-4 py-2 text-sm rounded-lg"><i class="far fa-flag"></i> Mark for Review</button>
                     </div>
                     <div id="question-passage" class="prose prose-invert max-w-none bg-black/20 p-4 rounded-lg max-h-60 overflow-y-auto mb-6 text-text-secondary"></div>
                     <p class="text-lg leading-relaxed mb-6" id="question-text"></p>
                     <div id="options-container" class="space-y-3"></div>
                     <div class="flex justify-between mt-8">
                          <button id="prev-question-btn" class="btn-primary px-6 py-2 rounded-lg font-semibold"><i class="fas fa-arrow-left mr-2"></i> Prev</button>
                          <button id="next-question-btn" class="btn-primary px-6 py-2 rounded-lg font-semibold">Next <i class="fas fa-arrow-right ml-2"></i></button>
                     </div>
                 </div>

                 <div class="space-y-6">
                     <div class="bg-black/20 p-4 rounded-xl">
                         <h3 class="font-semibold mb-3">Question Navigator</h3>
                         <div id="question-grid-container" class="grid grid-cols-5 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-5 gap-2"></div>
                     </div>
                     <div id="desmos-card" class="bg-black/20 p-4 rounded-xl hidden">
                         <h3 class="font-semibold mb-3">Tools</h3>
                         <button id="open-desmos-btn" class="w-full btn-secondary py-2 rounded-lg font-semibold text-sm">
                             <i class="fas fa-calculator mr-2"></i> Open Calculator
                         </button>
                     </div>
                     <div id="test-ai-tutor-container" class="relative bg-black/20 p-4 rounded-xl">
                         <h3 class="font-semibold mb-2">AI Tutor</h3>
                         <p class="text-sm text-text-muted mb-3">Stuck? Ask Gemini for a hint!</p>
                         <button id="ask-ai-btn" class="w-full btn-primary py-2 rounded-lg font-semibold text-sm">
                             <i class="fas fa-robot mr-2"></i> Get a Hint
                         </button>
                     </div>
                 </div>
             </div>
         </div>
    </div>
    
    <div id="modal" class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 hidden z-50">
        <div class="glass-card rounded-2xl p-8 w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold"></h2>
                <button id="modal-close-btn" class="text-2xl hover:text-red-400 transition-colors">&times;</button>
            </div>
            <div id="modal-content" class="overflow-y-auto text-text-secondary prose prose-invert max-w-none"></div>
        </div>
    </div>
    
    <div id="level-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 hidden z-50">
        <div class="glass-card rounded-2xl p-8 w-full max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 id="level-modal-title" class="text-3xl font-bold">Select Level</h2>
                <button id="level-modal-close-btn" class="text-2xl hover:text-red-400 transition-colors">&times;</button>
            </div>
            <div id="level-selection-grid" class="grid md:grid-cols-3 gap-6">
                </div>
        </div>
    </div>
    
    <div id="desmos-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 hidden z-50">
        <div class="glass-card rounded-2xl p-4 w-full max-w-4xl h-[80vh] flex flex-col">
             <div class="flex justify-between items-center mb-2">
                 <h2 class="text-xl font-bold">Graphing Calculator</h2>
                 <button id="desmos-close-btn" class="text-2xl hover:text-red-400 transition-colors">&times;</button>
             </div>
             <iframe id="desmosFrame" src="https://www.desmos.com/calculator" class="w-full h-full rounded-lg border-none"></iframe>
        </div>
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            collection,
            query,
            where,
            getDocs,
            updateDoc,
            Timestamp,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCLd6NuSf_8fmd8540sXZQ-t5NxZwf8LX8",
            authDomain: "examprep-pro-ae45f.firebaseapp.com",
            projectId: "examprep-pro-ae45f",
            storageBucket: "examprep-pro-ae45f.appspot.com",
            messagingSenderId: "182362785845",
            appId: "1:182362785845:web:32b333925ab8c9925a897c",
            measurementId: "G-5T8Z5DXW34"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- App State ---
        let currentUser = null;
        let currentTestState = {};
        let testTimerInterval = null;

        // --- UI Elements ---
        const views = {
            loading: document.getElementById('loading-view'),
            auth: document.getElementById('auth-view'),
            dashboard: document.getElementById('dashboard-view'),
            test: document.getElementById('test-view')
        };
        
        // --- View Management ---
        function showView(viewName) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            const viewToShow = views[viewName];
            if (viewToShow) {
                viewToShow.classList.remove('hidden');
                viewToShow.classList.add('flex', 'items-center', 'justify-center');
            }
        }
        
        // --- Auth State Change Listener ---
        onAuthStateChanged(auth, async (user) => {
            views.loading.classList.remove('hidden');
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    currentUser = { uid: user.uid, ...userDoc.data() };
                    await updateUserStreak(user.uid, currentUser.lastLogin);
                    const updatedUserDoc = await getDoc(userDocRef);
                    currentUser = { uid: user.uid, ...updatedUserDoc.data() };
                    await setupDashboard();
                    showView('dashboard');
                } else {
                    signOut(auth);
                }
            } else {
                currentUser = null;
                showView('auth');
            }
            views.loading.classList.add('hidden');
        });

        // --- Authentication Logic ---
        document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form').classList.add('hidden'); document.getElementById('signup-form').classList.remove('hidden'); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('signup-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); });

        const authError = document.getElementById('auth-error');

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';
            const name = document.getElementById('signup-name').value;
            const username = document.getElementById('signup-username').value.toLowerCase();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            try {
                const usernameQuery = query(collection(db, "users"), where("username", "==", username));
                const usernameSnapshot = await getDocs(usernameQuery);
                if (!usernameSnapshot.empty) {
                    throw new Error("Username already exists.");
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                await updateProfile(user, { displayName: name });

                await setDoc(doc(db, "users", user.uid), {
                    displayName: name,
                    username: username,
                    email: email,
                    tier: 'free',
                    streak: 1,
                    lastLogin: Timestamp.now(),
                    createdAt: Timestamp.now(),
                    onboardingComplete: true
                });

            } catch (error) {
                console.error("Signup error:", error);
                authError.textContent = error.message;
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';
            let identifier = document.getElementById('login-identifier').value;
            const password = document.getElementById('login-password').value;
            let email = identifier;

            try {
                if (!identifier.includes('@')) {
                    const usernameQuery = query(collection(db, "users"), where("username", "==", identifier.toLowerCase()));
                    const usernameSnapshot = await getDocs(usernameQuery);
                    if (usernameSnapshot.empty) {
                        throw new Error("Invalid username or email.");
                    }
                    email = usernameSnapshot.docs[0].data().email;
                }
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login error:", error);
                authError.textContent = "Invalid credentials. Please try again.";
            }
        });


        // --- Streak Logic ---
        async function updateUserStreak(uid, lastLoginTimestamp) {
            if (!lastLoginTimestamp) {
                await updateDoc(doc(db, "users", uid), { lastLogin: Timestamp.now(), streak: 1 });
                return;
            }
            const lastLoginDate = lastLoginTimestamp.toDate();
            const today = new Date();
            
            const lastLogin = new Date(lastLoginDate.getFullYear(), lastLoginDate.getMonth(), lastLoginDate.getDate());
            const currentDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());

            const diffTime = currentDate - lastLogin;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let newStreak = currentUser.streak || 0;

            if (diffDays === 1) {
                newStreak++;
            } else if (diffDays > 1) {
                newStreak = 1;
            }

            if (diffDays > 0) {
                await updateDoc(doc(db, "users", uid), {
                    lastLogin: Timestamp.now(),
                    streak: newStreak
                });
            }
        }

        // --- Dashboard Logic ---
        async function setupDashboard() {
            document.getElementById('user-name').textContent = currentUser.displayName || 'User';
            document.getElementById('streak-count').textContent = currentUser.streak || 0;
            const tierBadge = document.getElementById('user-tier-badge');
            tierBadge.textContent = currentUser.tier.toUpperCase();
            tierBadge.className = `px-4 py-1 rounded-full font-semibold text-sm ${currentUser.tier === 'premium' ? 'bg-yellow-500/20 text-yellow-300' : 'bg-gray-500/20 text-gray-300'}`;
            document.getElementById('logout-button').onclick = () => signOut(auth);
            populateTestSelection();
            setupPremiumFeatures();
        }

        function populateTestSelection() {
            const grid = document.getElementById('test-selection-grid');
            grid.innerHTML = '';
            const tests = [
                { id: 'SAT', name: 'SAT', icon: 'fa-pencil-alt', desc: 'Math, Reading & Writing sections.' },
                { id: 'TOEFL', name: 'TOEFL', icon: 'fa-globe-americas', desc: 'Test of English as a Foreign Language.' },
                { id: 'IELTS', name: 'IELTS', icon: 'fa-book-reader', desc: 'International English Language Testing System.' }
            ];

            tests.forEach(test => {
                const card = document.createElement('div');
                card.className = "glass-card p-6 rounded-xl text-center hover:border-secondary-accent transition-all duration-300 cursor-pointer";
                card.innerHTML = `<i class="fas ${test.icon} text-4xl text-secondary-accent mb-4"></i><h4 class="text-xl font-semibold mb-2">${test.name}</h4><p class="text-text-muted text-sm">${test.desc}</p>`;
                card.onclick = () => showLevelSelection(test.id);
                grid.appendChild(card);
            });
        }
        
        function setupPremiumFeatures() {
            const aiTutorCard = document.getElementById('ai-tutor-card');
            if (currentUser.tier === 'premium') {
                aiTutorCard.classList.add('premium-feature');
                aiTutorCard.onclick = () => openAiTutorModal();
            } else {
                aiTutorCard.classList.add('disabled-feature');
                aiTutorCard.onclick = () => showModalMessage('Premium Feature', 'Please upgrade your account to use the AI Tutor.');
            }
        }

        function showLevelSelection(testSubject) {
            const modal = document.getElementById('level-modal');
            const title = document.getElementById('level-modal-title');
            const grid = document.getElementById('level-selection-grid');

            title.textContent = `Select ${testSubject} Level`;
            grid.innerHTML = ''; // Clear previous options

            const levels = [
                { id: 'Basic', icon: 'fa-seedling', desc: 'For building foundational skills.'},
                { id: 'Intermediate', icon: 'fa-chart-line', desc: 'For enhancing existing knowledge.'},
                { id: 'Advanced', icon: 'fa-rocket', desc: 'For mastering advanced concepts.'}
            ];

            levels.forEach(level => {
                const levelCard = document.createElement('div');
                levelCard.className = "glass-card p-6 rounded-xl text-center hover:border-primary-accent transition-all duration-300 cursor-pointer";
                levelCard.innerHTML = `
                    <i class="fas ${level.icon} text-4xl text-primary-accent mb-4"></i>
                    <h4 class="text-xl font-semibold mb-2">${level.id}</h4>
                    <p class="text-text-muted text-sm">${level.desc}</p>
                `;
                const testId = `${testSubject}-${level.id}`;
                levelCard.onclick = () => {
                    modal.classList.add('hidden');
                    loadTest(testId);
                };
                grid.appendChild(levelCard);
            });

            modal.classList.remove('hidden');
        }

        document.getElementById('level-modal-close-btn').onclick = () => {
            document.getElementById('level-modal').classList.add('hidden');
        };
        
        // --- Test Logic ---
        async function loadTest(testId) {
            showView('loading');
            try {
                const testDoc = await getDoc(doc(db, "tests", testId));
                if (!testDoc.exists()) throw new Error(`Test data for ${testId} not found in the database. Please run the one-time database setup from the login page.`);

                const testData = testDoc.data();
                
                let sectionKeys = Object.keys(testData).filter(k => k !== 'timeLimit');
                let firstSection = sectionKeys[0];
                let firstModule = Object.keys(testData[firstSection])[0];

                currentTestState = {
                    testId: testId,
                    data: testData,
                    currentSection: firstSection,
                    currentModule: firstModule, 
                    currentQuestionIndex: 0,
                    answers: {},
                    marked: {},
                    startTime: Date.now(),
                    timeRemaining: (testData.timeLimit || 30) * 60,
                };
                
                setupTestView();
                showView('test');
            } catch (error) {
                console.error("Error loading test:", error);
                showModalMessage('Error', error.message);
                showView('dashboard');
            }
        }

        function setupTestView() {
            document.getElementById('test-view-user-name').textContent = currentUser.displayName;
            document.getElementById('back-to-dashboard-btn').onclick = () => {
                if(confirm("Are you sure you want to exit? Your progress will not be saved.")) {
                    clearInterval(testTimerInterval);
                    showView('dashboard');
                }
            };
            document.getElementById('finish-test-btn').onclick = finishTest;
            document.getElementById('prev-question-btn').onclick = navigateQuestion.bind(null, -1);
            document.getElementById('next-question-btn').onclick = navigateQuestion.bind(null, 1);
            document.getElementById('mark-review-btn').onclick = markCurrentQuestion;
            document.getElementById('ask-ai-btn').onclick = askAiTutor;
            
            startTestTimer();
            renderCurrentQuestion();
        }

        function startTestTimer() {
            if (testTimerInterval) clearInterval(testTimerInterval);
            const timerDisplay = document.getElementById('test-timer-display');
            
            testTimerInterval = setInterval(() => {
                if (currentTestState.timeRemaining > 0) {
                    currentTestState.timeRemaining--;
                    const minutes = Math.floor(currentTestState.timeRemaining / 60);
                    const seconds = currentTestState.timeRemaining % 60;
                    timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                    clearInterval(testTimerInterval);
                    timerDisplay.textContent = "00:00";
                    finishTest();
                }
            }, 1000);
        }

        function renderCurrentQuestion() {
            const { testId, data, currentSection, currentModule, currentQuestionIndex } = currentTestState;
            const sectionData = data[currentSection][currentModule];
            const question = sectionData[currentQuestionIndex];
            
            document.getElementById('test-view-title').textContent = `${testId.replace('-', ' ')} - ${capitalize(currentSection)}`;
            document.getElementById('test-view-subtitle').textContent = `Module ${currentModule.replace('module', '')}`;
            document.getElementById('question-number-display').textContent = `Question ${currentQuestionIndex + 1} of ${sectionData.length}`;

            const passageEl = document.getElementById('question-passage');
            if (question.passage) {
                passageEl.textContent = question.passage;
                passageEl.style.display = 'block';
            } else {
                passageEl.style.display = 'none';
            }

            document.getElementById('question-text').textContent = question.q || question.question;

            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            const options = question.options || question.opts;
            options.forEach((opt, index) => {
                const optEl = document.createElement('div');
                optEl.className = 'option p-4 rounded-lg cursor-pointer hover:border-primary-accent';
                optEl.textContent = opt;
                
                const sectionKey = `${currentSection}.${currentModule}`;
                if (currentTestState.answers[sectionKey]?.[currentQuestionIndex] === index) {
                    optEl.classList.add('selected');
                }
                
                optEl.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(optEl);
            });
            
            document.getElementById('desmos-card').style.display = currentSection === 'math' ? 'block' : 'none';
            
            const askAiBtn = document.getElementById('ask-ai-btn');
            const aiContainer = document.getElementById('test-ai-tutor-container');
            if(currentUser.tier !== 'premium') {
                askAiBtn.disabled = true;
                askAiBtn.innerHTML = `<i class="fas fa-lock mr-2"></i> Premium Only`;
                aiContainer.classList.add('disabled-feature', 'premium-feature');
            } else {
                askAiBtn.disabled = false;
                askAiBtn.innerHTML = `<i class="fas fa-robot mr-2"></i> Get a Hint`;
                aiContainer.classList.remove('disabled-feature');
                aiContainer.classList.add('premium-feature');
            }
            
            updateNavButtons();
            updateQuestionGrid();
            updateMarkButton();
        }
        
        function selectAnswer(optionIndex) {
            const sectionKey = `${currentTestState.currentSection}.${currentTestState.currentModule}`;
            if (!currentTestState.answers[sectionKey]) {
                currentTestState.answers[sectionKey] = {};
            }
            currentTestState.answers[sectionKey][currentTestState.currentQuestionIndex] = optionIndex;
            renderCurrentQuestion();
        }

        function navigateQuestion(direction) {
            const newIndex = currentTestState.currentQuestionIndex + direction;
            const sectionData = currentTestState.data[currentTestState.currentSection][currentTestState.currentModule];
            
            if (newIndex >= 0 && newIndex < sectionData.length) {
                currentTestState.currentQuestionIndex = newIndex;
                renderCurrentQuestion();
            }
        }

        function goToQuestion(index) {
            currentTestState.currentQuestionIndex = index;
            renderCurrentQuestion();
        }

        function updateNavButtons() {
            const { currentQuestionIndex } = currentTestState;
            const sectionData = currentTestState.data[currentTestState.currentSection][currentTestState.currentModule];
            document.getElementById('prev-question-btn').disabled = currentQuestionIndex === 0;
            document.getElementById('next-question-btn').disabled = currentQuestionIndex === sectionData.length - 1;
        }

        function updateQuestionGrid() {
            const gridContainer = document.getElementById('question-grid-container');
            gridContainer.innerHTML = '';
            const sectionData = currentTestState.data[currentTestState.currentSection][currentTestState.currentModule];
            const sectionKey = `${currentTestState.currentSection}.${currentTestState.currentModule}`;

            sectionData.forEach((q, index) => {
                const item = document.createElement('button');
                item.textContent = index + 1;
                let classes = 'grid-item h-10 w-10 flex items-center justify-center rounded-md font-semibold transition-colors';
                if (currentTestState.answers[sectionKey]?.[index] !== undefined) classes += ' answered';
                if (currentTestState.marked[`${sectionKey}.${index}`]) classes += ' marked';
                if (index === currentTestState.currentQuestionIndex) classes += ' current';
                item.className = classes;
                item.onclick = () => goToQuestion(index);
                gridContainer.appendChild(item);
            });
        }
        
        function markCurrentQuestion() {
            const { currentSection, currentModule, currentQuestionIndex } = currentTestState;
            const key = `${currentSection}.${currentModule}.${currentQuestionIndex}`;
            currentTestState.marked[key] = !currentTestState.marked[key];
            updateMarkButton();
            updateQuestionGrid();
        }
        
        function updateMarkButton() {
            const { currentSection, currentModule, currentQuestionIndex } = currentTestState;
            const key = `${currentSection}.${currentModule}.${currentQuestionIndex}`;
            const btn = document.getElementById('mark-review-btn');
            if(currentTestState.marked[key]) {
                btn.innerHTML = `<i class="fas fa-flag mr-2"></i> Marked`;
                btn.classList.add('bg-yellow-500/20', 'text-yellow-300');
            } else {
                btn.innerHTML = `<i class="far fa-flag mr-2"></i> Mark for Review`;
                btn.classList.remove('bg-yellow-500/20', 'text-yellow-300');
            }
        }

        async function askAiTutor() {
            showModalMessage("AI Tutor", `<div class="flex justify-center items-center"><div class="loader"></div></div>`);
            
            const { data, currentSection, currentModule, currentQuestionIndex } = currentTestState;
            const question = data[currentSection][currentModule][currentQuestionIndex];
            const options = question.options || question.opts;

            const prompt = `I am a student taking a practice test. I'm stuck on the following question. Please provide a helpful hint without giving away the direct answer.
            
            Question: "${question.q || question.question}"
            
            Options:
            ${options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}
            `;

            try {
                const hint = await callGeminiApi(prompt);
                showModalMessage("AI Tutor's Hint", hint);
            } catch (error) {
                console.error("Gemini API error:", error);
                showModalMessage("AI Tutor Error", "Sorry, I couldn't get a hint for you right now.");
            }
        }

        async function callGeminiApi(prompt) {
            const apiKey = ""; // This will be provided by the execution environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                console.error("API Error Body:", errorBody);
                throw new Error(`API request failed with status ${response.status}`);
            }
            
            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text || "I'm sorry, I couldn't generate a response.";
        }
        
        function openAiTutorModal() {
            const content = `
                <p class="mb-4">You can ask the AI Tutor for help on any question during a test, or ask general study questions here.</p>
                <div class="space-y-4">
                    <textarea id="ai-tutor-prompt" class="w-full p-3 rounded-lg form-input h-32" placeholder="Ask a question about a concept, a problem, or a study strategy..."></textarea>
                    <button id="ai-tutor-submit" class="btn-primary px-6 py-2 rounded-lg">Ask Gemini</button>
                    <div id="ai-tutor-response-container" class="mt-4 p-4 bg-bg-secondary rounded-lg" style="display: none;">
                        <h4 class="font-semibold mb-2">Gemini's Response:</h4>
                        <div id="ai-tutor-response" class="prose prose-invert max-w-none"></div>
                    </div>
                </div>
            `;
            showModalMessage("AI Tutor", content);
            document.getElementById('ai-tutor-submit').onclick = async () => {
                const prompt = document.getElementById('ai-tutor-prompt').value;
                if (!prompt) return;

                const responseContainer = document.getElementById('ai-tutor-response-container');
                const responseEl = document.getElementById('ai-tutor-response');
                responseContainer.style.display = 'block';
                responseEl.innerHTML = `<div class="flex justify-center items-center"><div class="loader"></div></div>`;

                try {
                    const responseText = await callGeminiApi(`As a friendly AI tutor, please answer the following student question: ${prompt}`);
                    responseEl.innerText = responseText;
                } catch (e) {
                    responseEl.innerText = "Sorry, an error occurred. Please try again.";
                }
            };
        }


        function finishTest() {
            clearInterval(testTimerInterval);
            let correctAnswers = 0;
            let totalQuestions = 0;

            const { data, answers } = currentTestState;

            for(const sectionKey in answers) {
                const [section, module] = sectionKey.split('.');
                const sectionData = data[section][module];
                const userAnswers = answers[sectionKey];
                
                totalQuestions += sectionData.length;

                for(const qIndex in userAnswers) {
                    const question = sectionData[qIndex];
                    if (question && question.correct === userAnswers[qIndex]) {
                        correctAnswers++;
                    }
                }
            }
            
            const score = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
            const resultsHtml = `
                <h3 class="font-bold text-lg mb-2">Test Complete!</h3>
                <p>You answered <strong class="text-primary-accent">${correctAnswers}</strong> out of <strong class="text-primary-accent">${totalQuestions}</strong> questions correctly.</p>
                <div class="text-5xl font-bold my-6">Your Score: ${score}%</div>
                <button id="modal-dashboard-btn" class="btn-primary px-6 py-2 rounded-lg">Back to Dashboard</button>
            `;
            
            showModalMessage('Test Results', resultsHtml);
            document.getElementById('modal-dashboard-btn').onclick = () => {
                document.getElementById('modal').classList.add('hidden');
                showView('dashboard');
            };
        }

        // --- Utility & Modal Logic ---
        function showModalMessage(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal').classList.remove('hidden');
        }
        document.getElementById('modal-close-btn').onclick = () => document.getElementById('modal').classList.add('hidden');
        
        document.getElementById('open-desmos-btn').onclick = () => document.getElementById('desmos-modal').classList.remove('hidden');
        document.getElementById('desmos-close-btn').onclick = () => document.getElementById('desmos-modal').classList.add('hidden');

        function showPrivacyPolicy() { 
            const policyText = `
                <h3 class="font-bold text-lg mb-2">Privacy Policy</h3>
                <p>Your privacy is important to us. It is ExamPrep Pro's policy to respect your privacy regarding any information we may collect from you.</p>
                <h4 class="font-semibold mt-4 mb-2">1. Information We Collect</h4>
                <p>We only collect information necessary to provide our service, such as your name, email, and test progress. All data is stored securely.</p>
                <h4 class="font-semibold mt-4 mb-2">2. Use of Information</h4>
                <p>Your information is used to personalize your learning experience, track your progress, and manage your account. We do not sell your personal data to third parties.</p>
                <h4 class="font-semibold mt-4 mb-2">3. Security</h4>
                <p>We use industry-standard security measures to protect your data.</p>
            `;
            showModalMessage('Privacy Policy', policyText);
        }
        function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

        // --- Theme Toggle Logic ---
        const themeToggleButton = document.getElementById('theme-toggle-btn');
        const themeIcon = themeToggleButton.querySelector('i');

        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-mode');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            } else {
                document.body.classList.remove('light-mode');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            }
        }

        themeToggleButton.addEventListener('click', () => {
            const isLight = document.body.classList.contains('light-mode');
            const newTheme = isLight ? 'dark' : 'light';
            localStorage.setItem('examPrepTheme', newTheme);
            applyTheme(newTheme);
        });
        
        // Apply saved theme on load
        const savedTheme = localStorage.getItem('examPrepTheme') || 'dark';
        applyTheme(savedTheme);
        
        // --- Database Setup Logic (One-Time) ---
        const setupButton = document.getElementById('setup-db-btn');
        const setupStatus = document.getElementById('setup-status');
        setupButton.addEventListener('click', async () => {
            if (!confirm("This will upload all test questions to your database. This action should only be performed once. Continue?")) {
                return;
            }

            setupButton.disabled = true;
            setupStatus.textContent = 'Uploading... Please wait.';
            setupStatus.classList.add('text-yellow-400');

            try {
                const testData = {
                    "SAT-Basic": {
                        "timeLimit": 65,
                        "reading": {
                            "module1": [{
                                "passage": "The Sahara desert, covering most of North Africa, is the largest hot desert in the world. While it may seem barren, it is home to a variety of specially adapted plants and animals. The fennec fox, for example, has large ears that help it dissipate heat. Many plants have long roots to reach deep water sources.",
                                "q": "What is the main idea of the passage?",
                                "options": ["The fennec fox lives in the Sahara.", "The Sahara is a large, hot desert.", "The Sahara is too hot for any life.", "Despite its harsh climate, the Sahara supports adapted life."],
                                "correct": 3
                            }, {
                                "passage": "The Sahara desert, covering most of North Africa, is the largest hot desert in the world. While it may seem barren, it is home to a variety of specially adapted plants and animals. The fennec fox, for example, has large ears that help it dissipate heat. Many plants have long roots to reach deep water sources.",
                                "q": "The word 'barren' in the passage most nearly means:",
                                "options": ["Productive", "Empty and lifeless", "Mountainous", "Populated"],
                                "correct": 1
                            }, {
                                "passage": "The citys older neighborhoods were known for their tree-lined streets and small, family-owned shops. These shops, from the local bakery to the corner bookstore, provided not just goods but also a sense of community. However, the arrival of large chain stores on the outskirts of the city has started to change the local economy.",
                                "q": "According to the passage, the small shops provided more than just goods by also offering:",
                                "options": ["Higher paying jobs", "A sense of community", "A wider variety of products", "Lower prices"],
                                "correct": 1
                            }, {
                                "passage": "Bees are vital for pollination, the process that allows plants to reproduce. As bees gather nectar from flowers, pollen sticks to their bodies. They then carry this pollen to other flowers, fertilizing them. This process is essential for growing many of the fruits and vegetables we eat.",
                                "q": "What is the main role of bees described in the passage?",
                                "options": ["Making honey", "Building hives", "Helping plants reproduce", "Gathering nectar for food"],
                                "correct": 2
                            }, {
                                "passage": "Bees are vital for pollination, the process that allows plants to reproduce. As bees gather nectar from flowers, pollen sticks to their bodies. They then carry this pollen to other flowers, fertilizing them. This process is essential for growing many of the fruits and vegetables we eat.",
                                "q": "The word 'vital' in the passage is closest in meaning to:",
                                "options": ["Unimportant", "Dangerous", "Essential", "Optional"],
                                "correct": 2
                            }]
                        },
                        "math": {
                            "module1": [{
                                "q": "If 2x + 5 = 15, what is the value of x?",
                                "options": ["5", "10", "7.5", "20"],
                                "correct": 0
                            }, {
                                "q": "A rectangular garden is 8 feet long and 6 feet wide. What is its area in square feet?",
                                "options": ["14", "28", "48", "24"],
                                "correct": 2
                            }, {
                                "q": "What is 15% of 200?",
                                "options": ["15", "20", "30", "45"],
                                "correct": 2
                            }, {
                                "q": "If a pizza is cut into 8 equal slices and you eat 3 of them, what fraction of the pizza did you eat?",
                                "options": ["1/8", "3/8", "5/8", "1/3"],
                                "correct": 1
                            }, {
                                "q": "Solve for y: 4y - 7 = 13",
                                "options": ["3", "4", "5", "6"],
                                "correct": 2
                            }]
                        }
                    },
                    "SAT-Intermediate": {
                        "timeLimit": 65,
                        "reading": {
                            "module1": [{
                                "passage": "The theory of plate tectonics revolutionized geology in the mid-20th century. It posits that the Earth's outer shell is divided into several plates that glide over the mantle. The movement of these plates is responsible for earthquakes, volcanic eruptions, and the formation of mountain ranges. This unifying theory provided a framework for understanding a wide range of geological phenomena that were previously disconnected.",
                                "q": "The author's primary purpose in this passage is to:",
                                "options": ["Argue against the theory of plate tectonics.", "Explain the revolutionary impact of plate tectonics on geology.", "Detail the specific movements of each of the Earth's plates.", "Criticize geologists for not developing the theory sooner."],
                                "correct": 1
                            }, {
                                "passage": "The theory of plate tectonics revolutionized geology in the mid-20th century. It posits that the Earth's outer shell is divided into several plates that glide over the mantle. The movement of these plates is responsible for earthquakes, volcanic eruptions, and the formation of mountain ranges. This unifying theory provided a framework for understanding a wide range of geological phenomena that were previously disconnected.",
                                "q": "The word 'posits' in the passage is closest in meaning to:",
                                "options": ["Denies", "Questions", "Proves", "Suggests"],
                                "correct": 3
                            }, {
                                "passage": "The Great Barrier Reef is a complex ecosystem that is highly sensitive to changes in water temperature. Coral bleaching, a phenomenon where corals expel the algae living in their tissues, is a direct result of warmer ocean temperatures. This process is not immediately fatal to the coral, but prolonged bleaching can lead to its death, threatening the entire reef ecosystem.",
                                "q": "What can be inferred about the relationship between coral and algae?",
                                "options": ["They are in a symbiotic relationship.", "The algae are a parasite to the coral.", "The coral preys on the algae.", "They compete for the same resources."],
                                "correct": 0
                            }, {
                                "passage": "The Great Barrier Reef is a complex ecosystem that is highly sensitive to changes in water temperature. Coral bleaching, a phenomenon where corals expel the algae living in their tissues, is a direct result of warmer ocean temperatures. This process is not immediately fatal to the coral, but prolonged bleaching can lead to its death, threatening the entire reef ecosystem.",
                                "q": "Which choice best describes the author's tone in the passage?",
                                "options": ["Optimistic and hopeful", "Sarcastic and dismissive", "Informative and concerned", "Humorous and lighthearted"],
                                "correct": 2
                            }]
                        },
                        "math": {
                            "module1": [{
                                "q": "If f(x) = 3x - 4x + 2, what is the value of f(-2)?",
                                "options": ["-18", "6", "22", "18"],
                                "correct": 2
                            }, {
                                "q": "In the xy-plane, the line y = 3x - 5 is parallel to the line y = mx + 2. What is the value of m?",
                                "options": ["-1/3", "3", "-5", "2"],
                                "correct": 1
                            }, {
                                "q": "A circle has an area of 36. What is its circumference?",
                                "options": ["6", "12", "18", "36"],
                                "correct": 1
                            }, {
                                "q": "The price of a jacket was reduced by 20%. If the new price is $80, what was the original price?",
                                "options": ["$64", "$96", "$100", "$120"],
                                "correct": 2
                            }, {
                                "q": "What are the solutions to the equation x - 5x + 6 = 0?",
                                "options": ["x = -2, x = -3", "x = 2, x = 3", "x = -1, x = -6", "x = 1, x = 6"],
                                "correct": 1
                            }]
                        }
                    },
                    "SAT-Advanced": {
                        "timeLimit": 65,
                        "reading": {
                            "module1": [{
                                "passage": "Literary modernism, a movement that flourished in the late 19th and early 20th centuries, was characterized by a deliberate break with traditional forms and subject matter. Influenced by thinkers like Freud and Nietzsche, modernist writers explored the inner workings of human consciousness through techniques like stream of consciousness and interior monologue. This introspective turn represented a profound shift from the external, societal focus of Victorian literature.",
                                "q": "The passage suggests that the primary difference between modernist and Victorian literature is the former's emphasis on:",
                                "options": ["Strict narrative structures", "Social commentary", "Individual psychology", "Moral didacticism"],
                                "correct": 2
                            }, {
                                "passage": "Literary modernism, a movement that flourished in the late 19th and early 20th centuries, was characterized by a deliberate break with traditional forms and subject matter. Influenced by thinkers like Freud and Nietzsche, modernist writers explored the inner workings of human consciousness through techniques like stream of consciousness and interior monologue. This introspective turn represented a profound shift from the external, societal focus of Victorian literature.",
                                "q": "Which of the following techniques would a modernist writer most likely use to depict a character's thoughts?",
                                "options": ["A detailed third-person description of the character's actions.", "A direct statement from the narrator about the character's feelings.", "A fragmented and non-linear representation of the character's perceptions.", "A formal speech delivered by the character to a large audience."],
                                "correct": 2
                            }, {
                                "passage": "The philosophical concept of existentialism posits that individuals are free and responsible for giving their own meaning to life. It emphasizes human agency and the idea that 'existence precedes essence,' meaning that humans are not born with a predetermined purpose. Instead, they create their purpose through their choices and actions. This stands in contrast to essentialism, which holds that objects (and people) have a set of attributes that are necessary to their identity and function.",
                                "q": "According to the passage, an existentialist would most likely agree with which statement?",
                                "options": ["A person's destiny is determined by fate.", "The meaning of life is a universal truth to be discovered.", "Individuals define their own purpose in life.", "Societal roles are more important than individual choices."],
                                "correct": 2
                            }, {
                                "passage": "The philosophical concept of existentialism posits that individuals are free and responsible for giving their own meaning to life. It emphasizes human agency and the idea that 'existence precedes essence,' meaning that humans are not born with a predetermined purpose. Instead, they create their purpose through their choices and actions. This stands in contrast to essentialism, which holds that objects (and people) have a set of attributes that are necessary to their identity and function.",
                                "q": "The author contrasts existentialism with essentialism to:",
                                "options": ["Prove that essentialism is an outdated philosophy.", "Show that the two philosophies are actually identical.", "Argue that both philosophies are flawed.", "Clarify the core tenets of existentialism by showing what it is not."],
                                "correct": 3
                            }]
                        },
                        "math": {
                            "module1": [{
                                "q": "If i is the imaginary unit, what is the value of (3 + 2i)(4 - i)?",
                                "options": ["10 + 5i", "12 - 2i", "14 + 5i", "12 + 5i"],
                                "correct": 2
                            }, {
                                "q": "What is the sum of the solutions to the equation 2x - 8x + 5 = 0?",
                                "options": ["-4", "4", "-2.5", "2.5"],
                                "correct": 1
                            }, {
                                "q": "If sin(x) = 0.6 and x is in Quadrant II, what is the value of cos(x)?",
                                "options": ["0.8", "-0.8", "0.4", "-0.4"],
                                "correct": 1
                            }, {
                                "q": "A function is defined by h(t) = at + bt. If h(1) = 5 and h(2) = 14, what is the value of h(3)?",
                                "options": ["19", "23", "27", "31"],
                                "correct": 2
                            }, {
                                "q": "The equation of a circle in the xy-plane is x + y - 6x + 8y + 9 = 0. What is the radius of the circle?",
                                "options": ["3", "4", "5", "9"],
                                "correct": 1
                            }]
                        }
                    },
                    "IELTS-Basic": {
                        "timeLimit": 40,
                        "reading": {
                            "module1": [{
                                "passage": "Public libraries are essential community hubs. They provide free access to books, computers, and other resources. Many libraries also offer workshops on topics like job searching and learning new computer skills. For children, libraries often have story time sessions and summer reading programs to encourage literacy from a young age.",
                                "q": "According to the passage, which of these is NOT a service provided by public libraries?",
                                "opts": ["Free internet access", "Job placement services", "Children's reading programs", "Workshops for new skills"],
                                "correct": 1
                            }, {
                                "passage": "Public libraries are essential community hubs. They provide free access to books, computers, and other resources. Many libraries also offer workshops on topics like job searching and learning new computer skills. For children, libraries often have story time sessions and summer reading programs to encourage literacy from a young age.",
                                "q": "The main purpose of summer reading programs is to:",
                                "opts": ["Provide childcare", "Encourage children to read", "Help adults find jobs", "Teach computer skills"],
                                "correct": 1
                            }, {
                                "passage": "The water cycle describes how water moves on, above, and below the surface of the Earth. The main stages are evaporation, condensation, and precipitation. Evaporation is when the sun heats water in rivers or lakes and it turns into vapor. This vapor rises, cools, and turns into liquid, forming clouds. This is condensation. When too much water has condensed, it falls back to Earth as rain, which is precipitation.",
                                "q": "What happens during the condensation stage?",
                                "opts": ["Water falls as rain.", "The sun heats the water.", "Water vapor cools and forms clouds.", "Water flows into rivers."],
                                "correct": 2
                            }, {
                                "passage": "The water cycle describes how water moves on, above, and below the surface of the Earth. The main stages are evaporation, condensation, and precipitation. Evaporation is when the sun heats water in rivers or lakes and it turns into vapor. This vapor rises, cools, and turns into liquid, forming clouds. This is condensation. When too much water has condensed, it falls back to Earth as rain, which is precipitation.",
                                "q": "What is the final stage described in the passage?",
                                "opts": ["Evaporation", "Condensation", "Precipitation", "Collection"],
                                "correct": 2
                            }]
                        },
                        "writing": {
                            "module1": [{
                                "type": "task1",
                                "prompt": "The chart below shows the number of men and women in a company in 2010. Summarise the information by selecting and reporting the main features, and make comparisons where relevant."
                            }, {
                                "type": "task2",
                                "prompt": "Many people prefer to live in a city, while others think the countryside is a better place to live. Discuss both views and give your own opinion."
                            }]
                        }
                    },
                    "IELTS-Intermediate": {
                        "timeLimit": 60,
                        "reading": {
                            "module1": [{
                                "passage": "The phenomenon of urbanization has accelerated dramatically over the past century. While cities offer numerous opportunities for employment and education, this rapid growth also presents significant challenges. These include strained infrastructure, such as public transport and sanitation systems, as well as issues with affordable housing and increased pollution. Urban planning is therefore crucial to mitigate these negative effects and create sustainable urban environments.",
                                "q": "Which of the following is presented as a consequence of rapid urbanization?",
                                "opts": ["Decreased employment", "Improved public transport", "A lack of affordable housing", "Reduced pollution levels"],
                                "correct": 2
                            }, {
                                "passage": "The phenomenon of urbanization has accelerated dramatically over the past century. While cities offer numerous opportunities for employment and education, this rapid growth also presents significant challenges. These include strained infrastructure, such as public transport and sanitation systems, as well as issues with affordable housing and increased pollution. Urban planning is therefore crucial to mitigate these negative effects and create sustainable urban environments.",
                                "q": "The author suggests that urban planning is important for:",
                                "opts": ["Encouraging more people to move to cities", "Limiting access to education", "Managing the problems associated with urban growth", "Eliminating the need for public transport"],
                                "correct": 2
                            }, {
                                "passage": "Renewable energy sources, such as solar and wind power, are increasingly viewed as viable alternatives to fossil fuels. Their primary advantage is their minimal environmental impact, as they do not produce greenhouse gases that contribute to climate change. However, their adoption faces obstacles. For instance, solar and wind power are intermittentthey are not available 24/7. This necessitates the development of large-scale energy storage solutions to ensure a consistent power supply.",
                                "q": "What is the main challenge associated with solar and wind power mentioned in the text?",
                                "opts": ["They are more expensive than fossil fuels.", "They are not consistently available.", "They produce greenhouse gases.", "They are difficult to install."],
                                "correct": 1
                            }, {
                                "passage": "Renewable energy sources, such as solar and wind power, are increasingly viewed as viable alternatives to fossil fuels. Their primary advantage is their minimal environmental impact, as they do not produce greenhouse gases that contribute to climate change. However, their adoption faces obstacles. For instance, solar and wind power are intermittentthey are not available 24/7. This necessitates the development of large-scale energy storage solutions to ensure a consistent power supply.",
                                "q": "What solution is proposed to deal with the primary challenge?",
                                "opts": ["Using more fossil fuels.", "Developing better energy storage.", "Building more solar panels.", "Reducing energy consumption."],
                                "correct": 1
                            }]
                        },
                        "writing": {
                            "module1": [{
                                "type": "task1",
                                "prompt": "The two pie charts below show the percentage of online sales for different retail sectors in Canada in 2015 and 2020. Summarise the information by selecting and reporting the main features, and make comparisons where relevant."
                            }, {
                                "type": "task2",
                                "prompt": "Some people believe that governments should spend more money on public services, rather than on arts such as music and painting. To what extent do you agree or disagree?"
                            }]
                        }
                    },
                    "IELTS-Advanced": {
                        "timeLimit": 60,
                        "reading": {
                            "module1": [{
                                "passage": "The concept of 'neuroplasticity' fundamentally challenges the long-held belief that the adult brain is a static, unchanging organ. Research has demonstrated that the brain possesses a remarkable ability to reorganize itself by forming new neural connections throughout life. This adaptability allows the brain to compensate for injury and disease and to adjust its activities in response to new situations or changes in its environment. This principle underlies the therapeutic potential of cognitive-behavioral therapy and targeted rehabilitation after a stroke.",
                                "q": "What is the main idea of the passage?",
                                "opts": ["The adult brain is static and unchangeable.", "Neuroplasticity is a rare condition found in some individuals.", "The brain's ability to adapt and change has significant therapeutic implications.", "Cognitive-behavioral therapy is ineffective for brain injuries."],
                                "correct": 2
                            }, {
                                "passage": "The concept of 'neuroplasticity' fundamentally challenges the long-held belief that the adult brain is a static, unchanging organ. Research has demonstrated that the brain possesses a remarkable ability to reorganize itself by forming new neural connections throughout life. This adaptability allows the brain to compensate for injury and disease and to adjust its activities in response to new situations or changes in its environment. This principle underlies the therapeutic potential of cognitive-behavioral therapy and targeted rehabilitation after a stroke.",
                                "q": "The passage implies that neuroplasticity is a process that:",
                                "opts": ["Only occurs in childhood.", "Is a direct cause of brain disease.", "Ceases after an injury.", "Continues throughout a person's life."],
                                "correct": 3
                            }, {
                                "passage": "The Sapir-Whorf hypothesis posits a controversial relationship between the language an individual speaks and their perception of the world. The stronger version, linguistic determinism, claims that language dictates thought and that linguistic categories limit and determine cognitive categories. The weaker version, linguistic relativity, argues only that language influences thought, making it easier to conceive of certain ideas. While the strong version has been largely discredited, the principle of linguistic relativity continues to be a subject of empirical research and debate in linguistics and cognitive science.",
                                "q": "What is the main difference between linguistic determinism and linguistic relativity?",
                                "opts": ["Determinism claims language dictates thought, while relativity claims it only influences thought.", "Determinism is widely accepted, while relativity has been discredited.", "Determinism applies to written language, while relativity applies to spoken language.", "Determinism is a new theory, while relativity is an old one."],
                                "correct": 0
                            }, {
                                "passage": "The Sapir-Whorf hypothesis posits a controversial relationship between the language an individual speaks and their perception of the world. The stronger version, linguistic determinism, claims that language dictates thought and that linguistic categories limit and determine cognitive categories. The weaker version, linguistic relativity, argues only that language influences thought, making it easier to conceive of certain ideas. While the strong version has been largely discredited, the principle of linguistic relativity continues to be a subject of empirical research and debate in linguistics and cognitive science.",
                                "q": "The author's attitude toward the strong version of the Sapir-Whorf hypothesis can be best described as:",
                                "opts": ["Supportive", "Neutral", "Enthusiastic", "Skeptical"],
                                "correct": 3
                            }]
                        },
                        "writing": {
                            "module1": [{
                                "type": "task1",
                                "prompt": "The diagram illustrates the process of how coffee is produced, from picking the beans to packaging for sale in shops. Summarise the information by selecting and reporting the main features, and make comparisons where relevant."
                            }, {
                                "type": "task2",
                                "prompt": "In some countries, a few people earn extremely high salaries. Some people think that this is good for a country, while others believe that governments should control salaries and limit the amount people can earn. Discuss both views and give your own opinion."
                            }]
                        }
                    },
                    "TOEFL-Basic": {
                        "timeLimit": 20,
                        "reading": {
                            "module1": [{
                                "passage": "Photosynthesis is the process used by plants to convert light energy into chemical energy. This process is crucial for life on Earth as it produces most of the planet's oxygen. The main ingredients for photosynthesis are sunlight, water, and carbon dioxide. The plant's leaves contain chlorophyll, a green pigment that absorbs sunlight.",
                                "q": "What is the main purpose of photosynthesis?",
                                "options": ["To absorb water from the soil.", "To release carbon dioxide into the air.", "To convert light into chemical energy.", "To give leaves their green color."],
                                "correct": 2
                            }, {
                                "passage": "Photosynthesis is the process used by plants to convert light energy into chemical energy. This process is crucial for life on Earth as it produces most of the planet's oxygen. The main ingredients for photosynthesis are sunlight, water, and carbon dioxide. The plant's leaves contain chlorophyll, a green pigment that absorbs sunlight.",
                                "q": "According to the passage, what role does chlorophyll play?",
                                "options": ["It absorbs sunlight.", "It produces water.", "It releases oxygen.", "It captures carbon dioxide."],
                                "correct": 0
                            }, {
                                "passage": "The moon is Earth's only natural satellite. It is much smaller than the Earth and has no atmosphere. This means there is no weather, no wind, and the sky always appears black. The surface is covered with craters, which were formed by asteroids and comets hitting the moon over billions of years.",
                                "q": "Why does the moon's sky always look black?",
                                "options": ["Because it is far from the sun.", "Because it has no atmosphere.", "Because it is covered in dark dust.", "Because it does not rotate."],
                                "correct": 1
                            }, {
                                "passage": "The moon is Earth's only natural satellite. It is much smaller than the Earth and has no atmosphere. This means there is no weather, no wind, and the sky always appears black. The surface is covered with craters, which were formed by asteroids and comets hitting the moon over billions of years.",
                                "q": "What caused the craters on the moon's surface?",
                                "options": ["Volcanic eruptions", "Erosion by wind and water", "Impacts from asteroids and comets", "Movement of lunar plates."],
                                "correct": 2
                            }]
                        }
                    },
                    "TOEFL-Intermediate": {
                        "timeLimit": 20,
                        "reading": {
                            "module1": [{
                                "passage": "Echolocation is a biological sonar used by several animal species, most notably bats and dolphins. These animals emit calls out to the environment and listen to the echoes of those calls that return from various objects near them. They use these echoes to locate and identify the objects. Echolocation is used for navigation, foraging, and hunting in various environments, especially in conditions of low visibility.",
                                "q": "What is the primary function of the echoes in echolocation?",
                                "options": ["To scare away predators.", "To communicate with other animals.", "To create light in dark environments.", "To provide information about the surroundings."],
                                "correct": 3
                            }, {
                                "passage": "Echolocation is a biological sonar used by several animal species, most notably bats and dolphins. These animals emit calls out to the environment and listen to the echoes of those calls that return from various objects near them. They use these echoes to locate and identify the objects. Echolocation is used for navigation, foraging, and hunting in various environments, especially in conditions of low visibility.",
                                "q": "The word 'emit' in the passage is closest in meaning to:",
                                "options": ["Absorb", "Receive", "Send out", "Silence"],
                                "correct": 2
                            }, {
                                "passage": "The printing press, invented by Johannes Gutenberg around 1440, was a landmark invention that profoundly altered the course of human history. Before its invention, books were handwritten and prohibitively expensive, making them accessible only to a small, wealthy elite. The printing press allowed for the mass production of books, drastically lowering their cost and making knowledge and ideas accessible to a much wider audience. This democratization of information fueled the Renaissance, the Reformation, and the Age of Enlightenment.",
                                "q": "What was the main consequence of the invention of the printing press?",
                                "options": ["It made books more expensive.", "It limited the spread of new ideas.", "It made information more widely available.", "It was only used by the wealthy elite."],
                                "correct": 2
                            }, {
                                "passage": "The printing press, invented by Johannes Gutenberg around 1440, was a landmark invention that profoundly altered the course of human history. Before its invention, books were handwritten and prohibitively expensive, making them accessible only to a small, wealthy elite. The printing press allowed for the mass production of books, drastically lowering their cost and making knowledge and ideas accessible to a much wider audience. This democratization of information fueled the Renaissance, the Reformation, and the Age of Enlightenment.",
                                "q": "The word 'profoundly' in the passage is closest in meaning to:",
                                "options": ["Slightly", "Negatively", "Significantly", "Temporarily"],
                                "correct": 2
                            }]
                        }
                    },
                    "TOEFL-Advanced": {
                        "timeLimit": 20,
                        "reading": {
                            "module1": [{
                                "passage": "The Cambrian explosion, which occurred approximately 541 million years ago, was a period of rapid evolutionary diversification, during which most major animal phyla started appearing in the fossil record. The relatively short timeframe of this event has been a source of intense scientific debate. While some theories attribute this diversification to environmental changes, such as a rise in atmospheric oxygen, others point to genetic or developmental innovations, such as the evolution of Hox genes, which control body plan development.",
                                "q": "The passage is primarily concerned with:",
                                "options": ["Criticizing the fossil record of the Cambrian period.", "Discussing the various theories explaining the Cambrian explosion.", "Establishing a definitive timeline for the evolution of Hox genes.", "Arguing that environmental changes were the sole cause of diversification."],
                                "correct": 1
                            }, {
                                "passage": "The Cambrian explosion, which occurred approximately 541 million years ago, was a period of rapid evolutionary diversification, during which most major animal phyla started appearing in the fossil record. The relatively short timeframe of this event has been a source of intense scientific debate. While some theories attribute this diversification to environmental changes, such as a rise in atmospheric oxygen, others point to genetic or developmental innovations, such as the evolution of Hox genes, which control body plan development.",
                                "q": "According to the passage, what is a key point of debate regarding the Cambrian explosion?",
                                "options": ["Whether it occurred on land or in the sea.", "The exact number of species that evolved.", "The cause of the rapid diversification.", "Why it did not happen sooner."],
                                "correct": 2
                            }, {
                                "passage": "In economics, the principle of comparative advantage suggests that countries can gain from trade if they specialize in producing the goods in which they have a lower opportunity cost. This is distinct from absolute advantage, which refers to being able to produce a good using fewer inputs. A country can have an absolute advantage in producing all goods, but it will still benefit from trading with another country that has a comparative advantage in a particular good. This specialization increases total global production and allows both trading partners to consume more than they could in isolation.",
                                "q": "Which of the following is the best example of a country having a comparative advantage?",
                                "options": ["A country that can produce more of all goods than any other country.", "A country that can produce a specific good at a lower opportunity cost than its trading partners.", "A country that refuses to trade with other nations to protect its own industries.", "A country that can produce a specific good using the fewest resources."],
                                "correct": 1
                            }, {
                                "passage": "In economics, the principle of comparative advantage suggests that countries can gain from trade if they specialize in producing the goods in which they have a lower opportunity cost. This is distinct from absolute advantage, which refers to being able to produce a good using fewer inputs. A country can have an absolute advantage in producing all goods, but it will still benefit from trading with another country that has a comparative advantage in a particular good. This specialization increases total global production and allows both trading partners to consume more than they could in isolation.",
                                "q": "The author mentions 'absolute advantage' in order to:",
                                "options": ["Suggest it is more important than comparative advantage.", "Argue that it is the main driver of international trade.", "Provide a counterexample to the theory of trade.", "Distinguish it from the central concept of comparative advantage."],
                                "correct": 3
                            }]
                        }
                    }
                };
                
                const batch = writeBatch(db);
                for (const testId in testData) {
                    const docRef = doc(db, "tests", testId);
                    batch.set(docRef, testData[testId]);
                }
                await batch.commit();
                
                setupStatus.textContent = 'Database initialized successfully!';
                setupStatus.classList.remove('text-yellow-400');
                setupStatus.classList.add('green-400');

            } catch (error) {
                console.error("Database setup error:", error);
                setupStatus.textContent = `Error: ${error.message}`;
                setupStatus.classList.add('text-red-400');
                setupButton.disabled = false;
            }
        });
        
    </script>
</body>
</html>
